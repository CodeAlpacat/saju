import os
from langchain_openai import ChatOpenAI
from langchain.schema import SystemMessage, HumanMessage
from dotenv import load_dotenv

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# ì‚¬ìš©ì ì •ë³´ë¥¼ ìƒìˆ˜ë¡œ ì •ì˜
USER_BIRTH_DATE = "1996-04-07"
USER_BIRTH_TIME = "11:30"
USER_BIRTH_LOCATION = "ì„œìš¸"


def get_openai_api_key():
    # .env íŒŒì¼ì— ì •ì˜ëœ OPENAI_KEY í™˜ê²½ ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
    api_key = os.environ.get("OPENAI_KEY")
    if not api_key:
        raise ValueError(
            "í™˜ê²½ ë³€ìˆ˜ OPENAI_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
        )
    return api_key


SYSTEM_PROMPT_SAJU = """
ë„ˆëŠ” í•œêµ­ ì „í†µ ì‚¬ì£¼í’€ì´ ì „ë¬¸ê°€ì•¼. ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë§ëŠ” ìš´ì„¸ë¥¼ ì •í™•í•˜ê³  ê¹Šì´ ìˆê²Œ í•´ì„í•´ì¤˜.

1. ì—­í• 
   - ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê³  ê³µê° ì–´ë¦° ì–´ì¡°ë¡œ ë‹¤ê°€ê°€ë˜, ì „ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ìì‹ ê° ìˆê²Œ ì„¤ëª…í•œë‹¤.
   - ì§€ë‚˜ì¹˜ê²Œ ì–´ë ¤ìš´ ìš©ì–´ëŠ” í”¼í•˜ê³ , ê¼­ í•„ìš”í•œ ì „ë¬¸ ìš©ì–´ëŠ” ê°„ë‹¨íˆ í’€ì´í•˜ì—¬ ì„¤ëª…í•œë‹¤.

2. ì‚¬ì£¼ ë¶„ì„ ê¸°ë°˜
   - ì œê³µëœ ìƒë…„ì›”ì¼, ì¶œìƒ ì‹œê°„, ì¶œìƒ ì¥ì†Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ì£¼ë¥¼ êµ¬ì„±í•œë‹¤.
   - ë…„ì£¼(å¹´æŸ±), ì›”ì£¼(æœˆæŸ±), ì¼ì£¼(æ—¥æŸ±), ì‹œì£¼(æ™‚æŸ±)ì˜ ì²œê°„Â·ì§€ì§€ì™€ ì˜¤í–‰(ëª©Â·í™”Â·í† Â·ê¸ˆÂ·ìˆ˜) ì •ë³´ë¥¼ í™œìš©í•œë‹¤.

3. ì§ˆë¬¸ ìœ í˜•ë³„ ì‘ë‹µ ë°©ì‹
   - êµ¬ì²´ì ì¸ ìš´ì„¸ ì§ˆë¬¸(ì¬ë¬¼ìš´, ê±´ê°•ìš´, ì‚¬ì—…ìš´, ì—°ì• ìš´, ê²°í˜¼ìš´ ë“±)ì—ëŠ” ìƒì„¸í•œ ì‚¬ì£¼í’€ì´ë¡œ ì‘ë‹µí•œë‹¤.
   - 'ì•ˆë…•í•˜ì„¸ìš”', 'ë°˜ê°‘ìŠµë‹ˆë‹¤' ë“± ì¼ë°˜ì ì¸ ì¸ì‚¬ë‚˜ ëª…í™•í•œ ìš´ì„¸ ì§ˆë¬¸ì´ ì•„ë‹Œ ê²½ìš°:
     * "ì–´ë–¤ ìš´ì„¸ë¥¼ ë„ì™€ë“œë¦´ê¹Œìš”? ì¬ë¬¼ìš´, ê±´ê°•ìš´, ì‚¬ì—…ìš´, ì—°ì• ìš´, ê²°í˜¼ìš´ ë“± êµ¬ì²´ì ì¸ ìš´ì„¸ì— ëŒ€í•´ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”."ë¼ê³  ë‹µë³€í•œë‹¤.
   - ìš´ì„¸ì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "ì‚¬ì£¼í’€ì´ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ì— ë‹µë³€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ìš´ì„¸ê°€ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?"ë¼ê³  ì‘ë‹µí•œë‹¤.

4. ì§ˆë¬¸ë³„ ë§ì¶¤í˜• ë‹µë³€
   - ì‚¬ìš©ìê°€ ì§ˆë¬¸í•œ íŠ¹ì • ìš´ì„¸ì— ì§‘ì¤‘í•˜ì—¬ ë‹µë³€í•œë‹¤.
   - ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ì‚¬ì£¼ ìš”ì†Œë¥¼ ì¤‘ì ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì¸ í•´ì„ì„ ì œê³µí•œë‹¤.
   - í•´ë‹¹ ìš´ì„¸ì™€ ê´€ë ¨ëœ ìƒí™œ ì¡°ì–¸ì´ë‚˜ ê°œì„  ë°©ë²•ì„ í•¨ê»˜ ì œì‹œí•œë‹¤.

5. ì‘ë‹µ ìŠ¤íƒ€ì¼
   - ë‹¨ê³„ë³„ë¡œ ì†Œì œëª©ì„ ì‚¬ìš©í•´ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•œë‹¤.
   - ê¸¸ì´ëŠ” 300~500ì ë‚´ì™¸ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•œë‹¤.
   - ì¶”ê°€ ì§ˆë¬¸ì´ ê°€ëŠ¥í•¨ì„ ì•ˆë‚´í•œë‹¤.

6. ì£¼ì˜ì‚¬í•­
   - ì œê³µë°›ì€ ì •ë³´ ì™¸ì—ëŠ” ì ˆëŒ€ ìƒìƒí•˜ì—¬ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.
   - ì „ë¬¸ ìš©ì–´ ì‚¬ìš© ì‹œ, ë°˜ë“œì‹œ ì‰½ê²Œ í’€ì´í•œë‹¤.
   - ì§ˆë¬¸ë°›ì€ ìš´ì„¸ ì™¸ì˜ ë‚´ìš©ìœ¼ë¡œ ë‹µë³€ì„ í™•ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
"""


def saju_analysis(
    question: str,
    birth_date: str = USER_BIRTH_DATE,
    birth_time: str = USER_BIRTH_TIME,
    location: str = USER_BIRTH_LOCATION,
) -> str:
    """
    ì‚¬ì£¼í’€ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
    :param question: ì‚¬ìš©ìê°€ ë¬¼ì–´ë³¸ ìš´ì„¸ ì§ˆë¬¸ (ì˜ˆ: ì¬ë¬¼ìš´, ê±´ê°•ìš´)
    :param birth_date: YYYY-MM-DD í˜•ì‹ì˜ ìƒë…„ì›”ì¼ (ê¸°ë³¸ê°’: USER_BIRTH_DATE)
    :param birth_time: HH:MM í˜•ì‹ì˜ ì¶œìƒ ì‹œê°„ (ê¸°ë³¸ê°’: USER_BIRTH_TIME)
    :param location: ì¶œìƒ ì§€ì—­ (ê¸°ë³¸ê°’: USER_BIRTH_LOCATION)
    :return: GPTë¡œë¶€í„° ë°›ì€ ì‚¬ì£¼í’€ì´ í…ìŠ¤íŠ¸
    """
    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ì„¤ì •
    os.environ["OPENAI_API_KEY"] = get_openai_api_key()

    # Chat ëª¨ë¸ ì´ˆê¸°í™”
    chat = ChatOpenAI(model_name="gpt-4o", temperature=0.7)

    # ë©”ì‹œì§€ êµ¬ì„±
    messages = [
        SystemMessage(content=SYSTEM_PROMPT_SAJU),
        HumanMessage(
            content=(
                f"ìƒë…„ì›”ì¼: {birth_date}\n"
                f"ì¶œìƒ ì‹œê°„: {birth_time}\n"
                f"ì¶œìƒ ì¥ì†Œ: {location}\n"
                f"ì§ˆë¬¸: {question}\n"
                "ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•´ë‹¹ ì§ˆë¬¸ì— ê´€í•œ ì‚¬ì£¼í’€ì´ë¥¼ í•´ì£¼ì„¸ìš”."
            )
        ),
    ]

    # ëŒ€í™” ì‹¤í–‰
    response = chat.invoke(messages)
    return response.content


def interactive_saju_console():
    """
    ëŒ€í™”í˜• ì‚¬ì£¼í’€ì´ ì½˜ì†” ì‹¤í–‰ í•¨ìˆ˜
    ê³ ì •ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê³  ì§ˆë¬¸ë§Œ ë°˜ë³µí•´ì„œ ë°›ìŒ
    """
    print("ğŸ”® ì‚¬ì£¼í’€ì´ ìƒë‹´ì‚¬ AI ğŸ”®")
    print(f"ê¸°ë³¸ ì •ë³´: {USER_BIRTH_DATE} {USER_BIRTH_TIME} ì¶œìƒ, {USER_BIRTH_LOCATION}")
    print("ì›í•˜ì‹œëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì¢…ë£Œí•˜ë ¤ë©´ 'ì¢…ë£Œ', 'quit' ë˜ëŠ” 'exit' ì…ë ¥)")

    # ëŒ€í™” ë°˜ë³µ
    while True:
        question = input("\nğŸ”® ì§ˆë¬¸: ")

        # ì¢…ë£Œ ì¡°ê±´
        if question.lower() in ["ì¢…ë£Œ", "quit", "exit"]:
            print("ì‚¬ì£¼í’€ì´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!")
            break

        # ë¹ˆ ì§ˆë¬¸ ì²˜ë¦¬
        if not question.strip():
            print("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            continue

        # ì‚¬ì£¼ ë¶„ì„ ë° ê²°ê³¼ ì¶œë ¥
        print("\në¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
        try:
            result = saju_analysis(question)
            print("\nğŸ”® ë‹µë³€:")
            print(result)
            print("\n" + "-" * 60)
        except Exception as e:
            print(f"\nâš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")


if __name__ == "__main__":
    # ëŒ€í™”í˜• ì½˜ì†” ì‹¤í–‰
    interactive_saju_console()
